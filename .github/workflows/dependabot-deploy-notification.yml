name: Dependabot Deployment Notification

on:
  workflow_run:
    workflows: ["Azure Static Web Apps CI/CD"]
    types: [completed]
    branches: [main]

permissions:
  actions: read
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_commit.author.name == 'dependabot[bot]'
    steps:
      - name: Get Dependabot PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            // Get the commit message to extract PR info
            const commitMessage = context.payload.workflow_run.head_commit.message;
            const sha = context.payload.workflow_run.head_sha;
            
            // Try to find the associated PR
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });
            
            let prTitle = commitMessage.split('\n')[0];
            let prNumber = '';
            let prUrl = '';
            let prLinkHtml = '';
            
            if (prs.length > 0) {
              prTitle = prs[0].title;
              prNumber = prs[0].number;
              prUrl = prs[0].html_url;
              prLinkHtml = `<li><strong>PR:</strong> <a href="${prUrl}">#${prNumber}</a></li>`;
            }
            
            core.setOutput('pr-title', prTitle);
            core.setOutput('pr-number', prNumber);
            core.setOutput('pr-url', prUrl);
            core.setOutput('pr-link-html', prLinkHtml);
            core.setOutput('commit-sha', sha.substring(0, 7));

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3.9.0
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš€ Dependabot Release Deployed: ${{ steps.pr-info.outputs.pr-title }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_FROM }}
          html_body: |
            <h2>Dependabot Deployment Complete</h2>
            <p>A dependency update from Dependabot has been automatically merged and deployed to production.</p>
            <h3>Details</h3>
            <ul>
              <li><strong>Update:</strong> ${{ steps.pr-info.outputs.pr-title }}</li>
              ${{ steps.pr-info.outputs.pr-link-html }}
              <li><strong>Commit:</strong> <code>${{ steps.pr-info.outputs.commit-sha }}</code></li>
              <li><strong>Workflow Run:</strong> <a href="${{ github.event.workflow_run.html_url }}">View Details</a></li>
              <li><strong>Deployed at:</strong> ${{ github.event.workflow_run.updated_at }}</li>
            </ul>
            <hr>
            <p><em>This notification was generated by the Dependabot Deployment Notification workflow.</em></p>

      - name: Summary
        run: |
          echo "## ðŸš€ Dependabot Deployment Notification Sent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An email notification has been sent for the Dependabot deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
