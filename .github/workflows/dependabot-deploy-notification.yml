name: Dependabot Deployment Notification

on:
  workflow_run:
    workflows: ["Azure Static Web Apps CI/CD"]
    types: [completed]
    branches: [main]

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  notify:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_commit.author.name == 'dependabot[bot]'
    steps:
      - name: Get Dependabot PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            // Get the commit message to extract PR info
            const commitMessage = context.payload.workflow_run.head_commit.message;
            const sha = context.payload.workflow_run.head_sha;
            
            // Try to find the associated PR
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha
            });
            
            let prTitle = commitMessage.split('\n')[0];
            let prNumber = '';
            let prUrl = '';
            
            if (prs.length > 0) {
              prTitle = prs[0].title;
              prNumber = prs[0].number;
              prUrl = prs[0].html_url;
            }
            
            core.setOutput('pr-title', prTitle);
            core.setOutput('pr-number', prNumber);
            core.setOutput('pr-url', prUrl);
            core.setOutput('commit-sha', sha.substring(0, 7));

      - name: Create notification issue
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = '${{ steps.pr-info.outputs.pr-title }}';
            const prNumber = '${{ steps.pr-info.outputs.pr-number }}';
            const prUrl = '${{ steps.pr-info.outputs.pr-url }}';
            const commitSha = '${{ steps.pr-info.outputs.commit-sha }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            
            const title = `ðŸš€ Dependabot Release Deployed: ${prTitle}`;
            const body = [
              '## Dependabot Deployment Complete',
              '',
              'A dependency update from Dependabot has been automatically merged and deployed to production.',
              '',
              '### Details',
              `- **Update:** ${prTitle}`,
              prNumber ? `- **PR:** #${prNumber} (${prUrl})` : '',
              `- **Commit:** \`${commitSha}\``,
              `- **Workflow Run:** [View Details](${runUrl})`,
              `- **Deployed at:** ${new Date().toISOString()}`,
              '',
              '### Labels',
              'This issue will be automatically closed after review.',
              '',
              '---',
              '*This notification was generated by the Dependabot Deployment Notification workflow.*'
            ].filter(Boolean).join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependabot', 'deployment-notification']
            });

      - name: Summary
        run: |
          echo "## ðŸš€ Dependabot Deployment Notification Sent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A notification issue has been created for the Dependabot deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
