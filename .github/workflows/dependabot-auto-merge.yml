name: Dependabot Auto-Merge

on:
  workflow_run:
    workflows: ['Deploy PR Preview']
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  actions: read
  workflows: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'
    steps:
      - name: Get PR info from workflow run
        id: pr-info
        uses: actions/github-script@v8
        with:
          script: |
            // Get the PR associated with the workflow run
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Use the pull_requests array from the workflow run
            const prs = workflowRun.pull_requests;

            if (!prs || prs.length === 0) {
              // Fallback: search for PR by head branch
              const { data: searchPrs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open'
              });
              
              if (searchPrs.length === 0) {
                core.setFailed('No open PR found for this workflow run');
                return;
              }
              
              core.setOutput('pr-number', searchPrs[0].number);
              core.setOutput('pr-url', searchPrs[0].html_url);
              core.setOutput('pr-title', searchPrs[0].title);
              return;
            }

            const pr = prs[0];
            core.setOutput('pr-number', pr.number);
            core.setOutput('pr-url', pr.url.replace('api.github.com/repos', 'github.com').replace('/pulls/', '/pull/'));

            // Fetch full PR details for the title
            const { data: prDetails } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            core.setOutput('pr-title', prDetails.title);

      - name: Enable auto-merge for Dependabot PRs
        id: auto-merge
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ steps.pr-info.outputs.pr-number }}';
            
            if (!prNumber || prNumber === '') {
              core.setFailed('No PR number available');
              return;
            }
            
            // Enable auto-merge using GraphQL API
            // This works better than gh CLI for PRs that modify workflow files
            const query = `
              mutation EnableAutoMerge($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;
            
            // Get the PR node ID first
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber, 10)
            });
            
            try {
              await github.graphql(query, {
                pullRequestId: pr.node_id
              });
              core.info(`Auto-merge enabled for PR #${prNumber}`);
              core.setOutput('enabled', 'true');
            } catch (error) {
              // If auto-merge fails (e.g., branch protection not met), log but don't fail
              // Sanitize error message to avoid exposing sensitive information
              const sanitizedError = error.message.replace(/ghp_[a-zA-Z0-9]+/g, '[REDACTED]')
                                                  .replace(/gho_[a-zA-Z0-9]+/g, '[REDACTED]')
                                                  .replace(/github_pat_[a-zA-Z0-9]+/g, '[REDACTED]');
              core.warning(`Could not enable auto-merge: ${sanitizedError}`);
              core.info('This may happen if branch protection rules are not satisfied yet.');
              core.setOutput('enabled', 'false');
              core.setOutput('error', sanitizedError);
            }

      - name: Summary
        run: |
          echo "## ðŸ¤– Dependabot Auto-Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ steps.pr-info.outputs.pr-title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.auto-merge.outputs.enabled }}" == "true" ]; then
            echo "âœ… Auto-merge enabled with squash strategy." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Could not enable auto-merge: ${{ steps.auto-merge.outputs.error }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The PR may need manual review or branch protection requirements are not met." >> $GITHUB_STEP_SUMMARY
          fi
