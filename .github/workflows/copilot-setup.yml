name: GitHub Copilot Setup Check

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-setup-check:
    runs-on: ubuntu-latest
    name: Verify Copilot Configuration
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for AGENTS.md
        id: check_agents
        run: |
          if [ -f "AGENTS.md" ]; then
            echo "✅ AGENTS.md found - Copilot custom instructions are configured"
            echo "agents_exists=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ AGENTS.md not found - Consider adding custom instructions for Copilot"
            echo "agents_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Project Documentation
        run: |
          echo "Checking project documentation for Copilot context..."

          docs=("README.md" "PRD.md" "DEPLOYMENT.md")
          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "✅ $doc exists"
            else
              echo "⚠️ $doc missing"
            fi
          done

      - name: Check TypeScript Configuration
        run: |
          if [ -f "tsconfig.json" ]; then
            echo "✅ TypeScript configuration found"
            if grep -q "strict" tsconfig.json; then
              echo "✅ Strict mode enabled"
            fi
          fi

      - name: Verify Test Setup
        run: |
          echo "Checking test infrastructure..."

          if [ -f "vitest.config.ts" ]; then
            echo "✅ Vitest configured for unit tests"
          fi

          if [ -f "playwright.config.ts" ]; then
            echo "✅ Playwright configured for E2E tests"
          fi

          if [ -d "src/test" ]; then
            test_count=$(find src/test -name "*.test.ts" -o -name "*.test.tsx" | wc -l)
            echo "✅ Found $test_count unit test file(s)"
          fi

          if [ -d "e2e" ]; then
            e2e_count=$(find e2e -name "*.spec.ts" -o -name "*.spec.tsx" | wc -l)
            echo "✅ Found $e2e_count E2E test file(s)"
          fi

      - name: Check Linting Setup
        run: |
          if [ -f "eslint.config.js" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            echo "✅ ESLint configured"
          fi

      - name: Verify Development Scripts
        run: |
          if [ -f "package.json" ]; then
            echo "Checking package.json scripts..."
            
            scripts=("dev" "build" "test" "lint")
            for script in "${scripts[@]}"; do
              if grep -q "\"$script\":" package.json; then
                echo "✅ npm run $script available"
              else
                echo "⚠️ npm run $script not found"
              fi
            done
          fi

      - name: Summary
        run: |
          echo "==================================================="
          echo "GitHub Copilot Setup Summary"
          echo "==================================================="
          echo ""
          echo "This workflow validates that the repository is properly"
          echo "configured for optimal GitHub Copilot assistance."
          echo ""
          echo "Key files:"
          echo "  - AGENTS.md: Custom instructions for Copilot"
          echo "  - README.md: Project overview and setup"
          echo "  - PRD.md: Product requirements"
          echo "  - TypeScript configs: Type definitions"
          echo "  - Test configs: Testing infrastructure"
          echo ""
          echo "For best Copilot experience, ensure all files are"
          echo "up-to-date and comprehensive."
          echo "==================================================="

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.check_agents.outputs.agents_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ℹ️ GitHub Copilot Setup\n\n' +
                    'This PR could benefit from adding `AGENTS.md` to provide custom instructions for GitHub Copilot.\n\n' +
                    'See [GitHub Copilot Custom Instructions](https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot) for more information.'
            })
